# Forward RCS Time Series Metrics (Request Count) to BQ via Pub/Sub
resource "google_pubsub_subscription" "rcs_timeseris_request_count_to_bq_sub" {
  name   = "rcs-timeseries-request-count-to-bigquery"
  topic  = google_pubsub_topic.ingest_api.name
  labels = local.resource_labels
  filter = "attributes.metric_type=\"custom.googleapis.com/rcs/sip/request_count\""

  bigquery_config {
    table          = "${google_bigquery_table.rcs_timeseris_request_count.project}.${google_bigquery_table.rcs_timeseris_request_count.dataset_id}.${google_bigquery_table.rcs_timeseris_request_count.table_id}"
    write_metadata = true
    # use_topic_schema = true
    # attributes {
    #   metric_type="metric_type"
    #   conversation_type= "conversation_type"
    #   carrier= "carrier"
    #   sip_method="sip_method"
    #   direction="direction"
    #   response_code="response_code"
    #   start_time="start_time"
    #   end_time="end_time"
    #   value="value"
    # }
  }

  depends_on = [
    google_project_iam_member.pubsub_bqEditor,
    google_project_iam_member.pubsub_bqMetadata
  ]
}

# Forward RCS Time Series Metrics (Final Response Count) to BQ via Pub/Sub
resource "google_pubsub_subscription" "rcs_timeseris_final_response_count_to_bq_sub" {
  name   = "rcs-timeseries-final-response-count-to-bigquery"
  topic  = google_pubsub_topic.ingest_api.name
  labels = local.resource_labels
  filter = "attributes.metric_type=\"custom.googleapis.com/rcs/sip/final_response_count\""

  bigquery_config {
    table          = "${google_bigquery_table.rcs_timeseris_final_response_count.project}.${google_bigquery_table.rcs_timeseris_final_response_count.dataset_id}.${google_bigquery_table.rcs_timeseris_final_response_count.table_id}"
    write_metadata = true
    # use_table_schema = true
    # attributes {
    #   metric_type="metric_type"
    #   conversation_type= "conversation_type"
    #   carrier= "carrier"
    #   sip_method="sip_method"
    #   direction="direction"
    #   response_code="response_code"
    #   start_time="start_time"
    #   end_time="end_time"
    #   value="value"
    # }
  }

  depends_on = [
    google_project_iam_member.pubsub_bqEditor,
    google_project_iam_member.pubsub_bqMetadata
  ]
}